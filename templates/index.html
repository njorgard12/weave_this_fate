<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weave This Fate</title>

  <!-- Fonts with grim vibe but readable -->
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --gold: #c9a96b;
      --gold-deep: #8b6f43;
      --parch: rgba(25,20,10,0.85);
      --ink: #e0d6b6;
    }

    body {
      background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
      color: var(--ink);
      font-family: "Cormorant Garamond", serif;
      margin: 0;
      text-align: center;
    }

    h1 {
      font-family: "Uncial Antiqua", serif;
      font-size: 3rem;
      color: #d4b16a;
      text-shadow: 2px 2px 10px #000, 0 0 15px var(--gold-deep);
      margin: 24px 0 10px;
      letter-spacing: .5px;
    }

    /* Control panel */
    #controls {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 12px 18px;
      align-items: center;
      justify-content: center;
      background: var(--parch);
      border: 2px solid var(--gold-deep);
      border-radius: 10px;
      padding: 16px 22px;
      box-shadow: 0 0 18px rgba(80,60,20,.4);
      margin-top: 10px;
    }

    label {
      font-family: "Uncial Antiqua", serif;
      color: var(--gold);
      letter-spacing: .5px;
    }

    select, button {
      font-family: "Uncial Antiqua", serif;
      font-size: 1.05rem;
      background: #2b2a29;
      color: var(--ink);
      border: 2px solid var(--gold-deep);
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      transition: .25s;
    }
    select:hover, button:hover {
      background: #3a342b;
      border-color: var(--gold);
    }

    /* Cards row */
    #cards-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 18px;
      margin: 32px auto 10px;
      max-width: 1100px;
      padding: 0 12px;
    }

    .card {
      background: rgba(30,25,15,.85);
      border: 2px solid var(--gold-deep);
      border-radius: 8px;
      padding: 6px;
      width: 160px;
      transition: transform .2s, box-shadow .2s;
    }
    .card img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
    }
    .card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px var(--gold);
    }
    .card-name {
      font-family: "Uncial Antiqua", serif;
      font-size: .95rem;
      color: #f2d28b;
      margin-top: 6px;
    }

    /* Story box */
    #story {
      font-size: 1.2rem;
      line-height: 1.7;
      background: var(--parch);
      border: 2px solid var(--gold-deep);
      border-radius: 10px;
      padding: 24px;
      max-width: 950px;
      margin: 24px auto 10px;
      text-align: justify;
      box-shadow: 0 0 20px rgba(80,60,20,.5);
      min-height: 48px;
    }

    #loading {
      display: none;
      font-family: "Uncial Antiqua", serif;
      font-size: 1.2rem;
      color: var(--gold);
      text-shadow: 0 0 8px var(--gold-deep);
      margin: 16px 0;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.08);
      border-top: 4px solid var(--gold);
      border-radius: 50%;
      width: 38px; height: 38px;
      margin: 8px auto 0;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #save-btn {
      display: none;
      margin: 18px auto 40px;
    }
  </style>
</head>

<body>
  <h1>Weave This Fate</h1>

  <!-- Controls use server-provided lists -->
  <div id="controls">
    <label for="profession">PROFESSION:</label>
    <select id="profession">
      {% for p in professions %}
        {% if p.name is defined %}
          <option value="{{ p.name }}">{{ p.name }}</option>
        {% else %}
          <option value="{{ p }}">{{ p }}</option>
        {% endif %}
      {% endfor %}
    </select>

    <label for="race">RACE:</label>
    <select id="race">
      {% for r in races %}
        <option value="{{ r }}">{{ r }}</option>
      {% endfor %}
    </select>

    <label for="gender">GENDER:</label>
    <select id="gender">
      {% for g in genders %}
        <option value="{{ g }}">{{ g }}</option>
      {% endfor %}
    </select>

    <button id="draw-btn">Draw New Cards</button>
    <button id="weave-btn" disabled>Weave Story</button>
  </div>

  <div id="cards-container"></div>

  <div id="loading">
    The threads of fate are weaving...
    <div class="spinner"></div>
  </div>

  <div id="story"></div>
  <button id="save-btn">Save This Fate</button>

  <script>
    const drawBtn = document.getElementById('draw-btn');
    const weaveBtn = document.getElementById('weave-btn');
    const cardsContainer = document.getElementById('cards-container');
    const storyDiv = document.getElementById('story');
    const loadingDiv = document.getElementById('loading');
    const saveBtn = document.getElementById('save-btn');

    let selectedCards = [];

    // Draw cards from /draw_cards (GET) — matches Flask
    drawBtn.addEventListener('click', async () => {
      storyDiv.innerHTML = '';
      saveBtn.style.display = 'none';

      const res = await fetch('/draw_cards');
      const cards = await res.json();
      selectedCards = cards;              // keep whole objects for backend

      // Render cards horizontally with correct static path
      cardsContainer.innerHTML = cards.map(c => {
        const imgPath = c.image && !c.image.startsWith('http')
          ? `/static/cards/${c.image}`
          : c.image || '';
        return `
          <div class="card">
            <img src="${imgPath}" alt="${c.name}" onerror="this.style.display='none'">
            <div class="card-name">${c.name}</div>
          </div>`;
      }).join('');

      weaveBtn.disabled = selectedCards.length !== 6;
    });

    // Ask server to generate using /generate_story (POST) with {selected_cards, race, profession, gender}
    weaveBtn.addEventListener('click', async () => {
      if (selectedCards.length !== 6) return;

      const race = document.getElementById('race').value;
      const profession = document.getElementById('profession').value;
      const gender = document.getElementById('gender').value;

      loadingDiv.style.display = 'block';
      storyDiv.innerHTML = '';

      const res = await fetch('/generate_story', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          selected_cards: selectedCards,
          race, profession, gender
        })
      });

      const data = await res.json();
      loadingDiv.style.display = 'none';

      if (data.error) {
        storyDiv.textContent = '⚠ ' + data.error;
        return;
      }

      // Clean up markdown-ish headings if model uses ###, or ensure bold labels render nicely
      const formatted = (data.story || '')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // bold
        .replace(/###\s*/g, '<br><br><strong>')
        .replace(/\n{2,}/g, '<br><br>')
        .replace(/\n/g, '<br>')
        .replace(/(<strong>(Origin|Strength|Weakness|Obstacle|Relationship|Destiny)\s*:?\s*)/gi, '$1</strong>');

      storyDiv.innerHTML = formatted;
      saveBtn.style.display = 'inline-block';
    });

    // Save the generated fate to a .txt file
    saveBtn.addEventListener('click', () => {
      const text = storyDiv.innerText.trim();
      if (!text) return;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'woven_fate.txt';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
